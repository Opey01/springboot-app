pipeline {
  agent any
  environment {
    AWS_REGION   = 'us-east-2'
    ECR_REGISTRY = '850924742604.dkr.ecr.us-east-2.amazonaws.com'
    ECR_REPO     = "${ECR_REGISTRY}/springboot-app"
  }

  stages {
    stage('Checkout') {
      steps {
        // Use the correct repo/branch; change 'main' to your actual default branch
        git branch: 'main', url: 'https://github.com/Opey01/springboot-app.git'
      }
    }

    stage('Build') {
      steps {
        sh 'mvn -B -f MyAwesomeApp/pom.xml clean package'
        archiveArtifacts artifacts: 'MyAwesomeApp/target/springbootApp.jar', fingerprint: true
      }
    }

    stage('Docker Build') {
      steps {
        script {
          env.IMAGE_TAG = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
          docker.build("${env.ECR_REPO}:${env.IMAGE_TAG}")
        }
      }
    }

    stage('Login & Push to ECR') {
      steps {
        sh """
          aws ecr get-login-password --region ${AWS_REGION} \
            | docker login --username AWS --password-stdin ${ECR_REGISTRY}
          docker push ${ECR_REPO}:${IMAGE_TAG}
        """
      }
    }
  }

  post {
    always { cleanWs() }
  }
}

